#LyX 2.3 created this file. For more info see http://www.lyx.org/
\lyxformat 544
\begin_document
\begin_header
\save_transient_properties true
\origin unavailable
\textclass article
\use_default_options true
\maintain_unincluded_children false
\language english
\language_package default
\inputencoding auto
\fontencoding global
\font_roman "default" "default"
\font_sans "default" "default"
\font_typewriter "default" "default"
\font_math "auto" "auto"
\font_default_family default
\use_non_tex_fonts false
\font_sc false
\font_osf false
\font_sf_scale 100 100
\font_tt_scale 100 100
\use_microtype false
\use_dash_ligatures true
\graphics default
\default_output_format default
\output_sync 0
\bibtex_command default
\index_command default
\paperfontsize default
\spacing single
\use_hyperref false
\papersize default
\use_geometry true
\use_package amsmath 1
\use_package amssymb 1
\use_package cancel 1
\use_package esint 1
\use_package mathdots 1
\use_package mathtools 1
\use_package mhchem 1
\use_package stackrel 1
\use_package stmaryrd 1
\use_package undertilde 1
\cite_engine basic
\cite_engine_type default
\biblio_style plain
\use_bibtopic false
\use_indices false
\paperorientation portrait
\suppress_date false
\justification true
\use_refstyle 1
\use_minted 0
\index Index
\shortcut idx
\color #008000
\end_index
\leftmargin 2cm
\topmargin 2cm
\rightmargin 2cm
\bottommargin 2cm
\secnumdepth 3
\tocdepth 3
\paragraph_separation indent
\paragraph_indentation default
\is_math_indent 0
\math_numbering_side default
\quotes_style english
\dynamic_quotes 0
\papercolumns 1
\papersides 1
\paperpagestyle default
\tracking_changes false
\output_changes false
\html_math_output 0
\html_css_as_file 0
\html_be_strict false
\end_header

\begin_body

\begin_layout Title
Planar 2-links robot simulator: report
\end_layout

\begin_layout Author
Luca Tarasi
\end_layout

\begin_layout Date
2019/09/18
\end_layout

\begin_layout Part*
Introduction
\end_layout

\begin_layout Subsection
Purpose
\end_layout

\begin_layout Standard
This package has the purpose of simulating a planar robot with two links.
 The links are ideal (uni-dimensional) and the actuator is modelled as a
 material point.
 Degree of freedom of the simulation are the lengths of the links, the maximum
 linear speed of the robot, the simulation step, the way the state of the
 simulation is to be plotted (or not) during the simulation itself, and,
 very importantly, the way the signal is to be provided to the simulator.
 There are three ways to do this:
\end_layout

\begin_layout Enumerate
Mode 1: the signal is already stored in some variables, in a row array format.
\end_layout

\begin_layout Enumerate
Mode 2: an arbitrary number of continuous signals can be plotted by the
 user by cursor; they will be stored and then simulated later.
\end_layout

\begin_layout Enumerate
Mode 3: an arbitrary number of continuous signals can be plotted by the
 user by cursor, so that the simulated robot will follow them in real time.
\end_layout

\begin_layout Standard
The package offers two user interface functions, 
\family typewriter
prepare_simulation
\family default
 and 
\family typewriter
start_simulation
\family default
.
 The former takes the parameter listed above (and, in case, other user inputs)
 as inputs, and returns a custom structure, which contains the parameters
 needed for the real simulation and is then to be given as input to 
\family typewriter
start_simulation
\family default
, which will effectively run the simulation.
 This call returns the significant signals of the simulation in a column
 vector format.
 Details on these functions are to be found in Part I.
 Other functions, used internally by these two, are specified in Part II.
 Finally, the Simulink model and the MATLAB interpreted functions used in
 it are described in Part III.
\end_layout

\begin_layout Subsection
Control method
\end_layout

\begin_layout Standard
As with any manipulator, we have 
\begin_inset Formula $\mathbf{\dot{x}=J\dot{q}}$
\end_inset

, where 
\begin_inset Formula $\mathbf{x}$
\end_inset

 is the position of the actuator, 
\begin_inset Formula $\mathbf{q}=(q1,q2)$
\end_inset

 is the vector of generalized coordinates and 
\begin_inset Formula $\mathbf{J}$
\end_inset

 is the Jacobian of the system.
 Define 
\begin_inset Formula $\mathbf{x^{*}}(t)$
\end_inset

 as the reference signal (the trajectory we want our robot to follow), which
 we require to be differentiable (and, therefore, continuous); observe that,
 since we work on a discrete (computer) system, 
\begin_inset Quotes eld
\end_inset

differentiable
\begin_inset Quotes erd
\end_inset

 will mean that the difference quotient, computed with a step 
\begin_inset Formula $h_{step}$
\end_inset

, exists and is less, in absolute value, than an arbitrary maximum value
 
\begin_inset Formula $v_{max}$
\end_inset

 (both 
\begin_inset Formula $h_{step}$
\end_inset

 and 
\begin_inset Formula $v_{max}$
\end_inset

 will be passed to 
\family typewriter
prepare_sim
\family default
 by the user as input parameters).
\end_layout

\begin_layout Standard
Define 
\begin_inset Formula $\boldsymbol{\delta}\mathbf{x}(t)\coloneqq\mathbf{x}(t)-\mathbf{x}^{*}(t)$
\end_inset

.
 Now, if J is invertible and well conditioned, i.e.
 we are sufficiently far from the singularity points, we can impose the
 following input signal,
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\mathbf{\dot{q}}=\mathbf{J}^{-1}(\mathbf{x}^{*}(t)-\mathbf{K\boldsymbol{\delta}x}(t))
\]

\end_inset


\end_layout

\begin_layout Standard
where 
\begin_inset Formula $\mathbf{K}$
\end_inset

 is a matrix with positive eigenvalues.
 We obtain
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{\delta}\dot{\mathbf{\mathbf{x}}}(t)=\dot{\mathbf{x}}(t)-\mathbf{\dot{x}}^{*}(t)=\mathbf{J\dot{q}}-\mathbf{\dot{x}}^{*}(t)=-\mathbf{K}\boldsymbol{\delta}\mathbf{x}(t)
\]

\end_inset


\end_layout

\begin_layout Standard
which yields 
\begin_inset Formula $\boldsymbol{\delta}\mathbf{x}=e^{-\mathbf{K}t}\boldsymbol{\delta}\mathbf{x}(t_{0})$
\end_inset

, where 
\begin_inset Formula $t_{0}$
\end_inset

 is the starting time of simulation.
 So, in general we'll have
\begin_inset Formula 
\[
\lim_{t\rightarrow\infty}\boldsymbol{\delta}\mathbf{x}(t)=\mathbf{0}
\]

\end_inset


\end_layout

\begin_layout Standard
while, if 
\begin_inset Formula $\boldsymbol{\delta}\mathbf{x}(t_{0})=0$
\end_inset

, 
\begin_inset Formula $\boldsymbol{\delta}\mathbf{x}(t)=\mathbf{0}$
\end_inset

 for all 
\begin_inset Formula $t\ge t_{0}$
\end_inset

.
 In the program, we will always aim to have null initial error, in order
 to have null error in the whole simulation (except for numerical errors);
 for this reason, we'll have to know the initial value of the signal and
 position the robot in the corresponding configuration before the start
 of the simulation.
\end_layout

\begin_layout Subsection
Decisions
\end_layout

\begin_layout Standard
During the development of the package, a few decisions had to be taken.
\end_layout

\begin_layout Enumerate
Under what abnormal circumstances does the simulation stop with error? At
 first, it was decided for this to happen when the reference point is unreachabl
e and when the reference signal's speed exceeds the maximum one of the robot.
 In the end, this is what was done for the 
\family typewriter
OFFLINE
\family default
 modes.
 In the 
\family typewriter
ONLINE
\family default
 mode, it is hard for the user to properly control the speed of the cursor
 as the plot is drawn in real-time; so, if the maximum speed is exceeded,
 the robot moves at its maximum speed possible, i.e.
 it tries to keep up with the user.
 Hopefully, the user will slow down to adapt to the robot's maximum pace.
 Of course, even in 
\family typewriter
ONLINE
\family default
 mode, an unreachable point causes the simulation to stop with error.
\end_layout

\begin_layout Enumerate
In the 
\family typewriter
ONLINE
\family default
 mode, the reference signal is not known before the beginning of the simulation;
 however, in order to have null error for each time instant (at least theoretica
lly), the robot is supposed to start at the initial conditions that correspond
 to the signal.
 To see how this can be handled, suppose that the robot is initially in
 an arbitrary configuration.
 When the user starts drawing the signal, in general a jump will happen
 (from the arbitrary initial point to the first drawn point); this is not
 realistic, as it would imply a very high (theoritically infinite) speed
 of the links.
 However, suppose there was a mechanism that, when the user starts drawing,
 computes a valid trajectory for the robot to reach the new point.
 In this simulator, it was decided to suppose that such a mechanism exists,
 and to consider as valid only the results of the simulations after the
 initial conditions have been reached.
 For details on how this is implemented, consult the Simulink model documentatio
n.
\end_layout

\begin_layout Enumerate
The simulator can be further developed, for example by creating a complete
 user interface, detailing the actuator's state (by attaching a frame of
 reference to it), associating a SimScape model to the Simulink scheme,
 considering situations with noise, and many other things.
 Because of time constraints, it was decided to omit these features for
 now.
\end_layout

\begin_layout Subsection
Conventions used in this report
\end_layout

\begin_layout Itemize
In the description of the exceptions, the term 
\family typewriter
caller
\family default
 stands for the name of the function that originally throwed the exception.
\end_layout

\begin_layout Part
User interface functions documentation
\end_layout

\begin_layout Section
prepare_simulation
\end_layout

\begin_layout Subsection
Definition
\end_layout

\begin_layout Standard

\family typewriter
function sim_struct = prepare_simulation (mode, plot_mode, vmax, l1, l2,
 h_step, tmin, tmax, xs, ys)
\end_layout

\begin_layout Subsection
Brief description
\end_layout

\begin_layout Standard
Returns a data structure containing data that will be used in the simulation
 (see 1.4), lets the user draw an arbitrary number of reference curves in
 mode 2, and opens a figure with a drawing of the reference signal in red
 in mode 1.
\end_layout

\begin_layout Subsection
Input parameters
\end_layout

\begin_layout Subsubsection
mode
\end_layout

\begin_layout Itemize
Type: string (valid values: 
\family typewriter
OFFLINE_GIVEN
\family default
, 
\family typewriter
OFFLINE_MANUAL
\family default
, 
\family typewriter
ONLINE
\family default
).
\end_layout

\begin_layout Itemize
Description: 
\family typewriter
OFFLINE_GIVEN
\family default
 for mode 1, 
\family typewriter
OFFLINE_MANUAL
\family default
 for mode 2, 
\family typewriter
ONLINE
\family default
 for mode 3.
\end_layout

\begin_layout Subsubsection
plot_mode
\end_layout

\begin_layout Itemize
Type: string (valid values: 
\family typewriter
NO_PLOT
\family default
, 
\family typewriter
PLOT_NO_LINKS
\family default
, 
\family typewriter
PLOT_WITH_LINKS
\family default
).
\end_layout

\begin_layout Itemize
Description: 
\family typewriter
NO_PLOT
\family default
 if no plot is desired during the simulation, 
\family typewriter
PLOT_NO_LINKS
\family default
 if only the plot of the robot position is wanted, 
\family typewriter
PLOT_WITH_LINKS
\family default
 if at each step the robot's links are to be plotted.
 First choice is not valid if 
\family typewriter
mode = ONLINE
\family default
.
\end_layout

\begin_layout Subsubsection
vmax
\end_layout

\begin_layout Itemize
Type: double (positive).
\end_layout

\begin_layout Itemize
Description: maximum absolute value of any component of the actuator's velocity.
\end_layout

\begin_layout Subsubsection
l1
\end_layout

\begin_layout Itemize
Type: double (positive).
\end_layout

\begin_layout Itemize
Description: length of link 1 of the robot.
\end_layout

\begin_layout Subsubsection
l2
\end_layout

\begin_layout Itemize
Type: double (positive).
\end_layout

\begin_layout Itemize
Description: length of link 2 of the robot.
\end_layout

\begin_layout Subsubsection
h_step
\end_layout

\begin_layout Itemize
Type: double (positive).
\end_layout

\begin_layout Itemize
Description: sampling step wanted for the simulation (in mode 1, it must
 be the sampling time of 
\family typewriter
xs
\family default
 and 
\family typewriter
ys
\family default
).
\end_layout

\begin_layout Subsubsection
tmin (only for mode 1)
\end_layout

\begin_layout Itemize
Type: double.
\end_layout

\begin_layout Itemize
Description: starting time of 
\family typewriter
xs
\family default
 and 
\family typewriter
ys
\family default
.
\end_layout

\begin_layout Subsubsection
tmax (only for mode 1)
\end_layout

\begin_layout Itemize
Type: double (greather than 
\family typewriter
tmin
\family default
).
\end_layout

\begin_layout Itemize
Description: final time of 
\family typewriter
xs
\family default
 and 
\family typewriter
ys
\family default
.
\end_layout

\begin_layout Subsubsection
xs (only for mode 1)
\end_layout

\begin_layout Itemize
Type: row vector of doubles of size equal to that of 
\family typewriter
ys
\family default
.
\end_layout

\begin_layout Itemize
Description: x component of the reference signal.
\end_layout

\begin_layout Subsubsection
ys (only for mode 1)
\end_layout

\begin_layout Itemize
Type: row vector of doubles of size equal to that of 
\family typewriter
xs
\family default
.
\end_layout

\begin_layout Itemize
Description: y component of the reference signal.
\end_layout

\begin_layout Subsection
Output parameters
\end_layout

\begin_layout Subsubsection
sim_struct
\end_layout

\begin_layout Standard
A custom data structure with the following fields: 
\family typewriter
h_step
\family default
, 
\family typewriter
l1
\family default
, 
\family typewriter
l2
\family default
, 
\family typewriter
vmax
\family default
, 
\family typewriter
sw
\family default
, 
\family typewriter
plot_mode_number
\family default
, 
\family typewriter
n
\family default
, 
\family typewriter
tmin
\family default
, 
\family typewriter
tmax
\family default
, 
\family typewriter
q1_initial
\family default
, 
\family typewriter
q2_initial
\family default
, 
\family typewriter
xstar
\family default
, 
\family typewriter
xstardot
\family default
 (the last 7 ones only in 
\family typewriter
OFFLINE
\family default
 modes).
\end_layout

\begin_layout Itemize
The first 4 ones are the input parameters of 
\family typewriter
prepare_simulation
\family default
 with the same name.
\end_layout

\begin_layout Itemize

\family typewriter
sw
\family default
 is the switching parameter, and has value -1 for mode 3, 1 for mode 1,
 2 for mode 2.
\end_layout

\begin_layout Itemize

\family typewriter
plot_mode_num
\family default
 = 
\family typewriter
plot_mode_str2int(plot_mode)
\family default
.
\end_layout

\begin_layout Itemize

\family typewriter
n
\family default
 = number of simulations requested by the user.
\end_layout

\begin_layout Itemize
The successive 4 fields are 
\family typewriter
n
\family default
-sized row vectors, where the 
\family typewriter
i
\family default
-th element contains, respectively, the initial time, final time, initial
 first angle and initial second angle of the 
\family typewriter
i
\family default
-th simulation (
\family typewriter
i
\family default
 = 1,..,
\family typewriter
n
\family default
).
\end_layout

\begin_layout Itemize

\family typewriter
xstar
\family default
 and 
\family typewriter
xstardot
\family default
 are 
\family typewriter
n
\family default
-sized cell array, where the 
\family typewriter
i
\family default
-th element contains, respectively, the signal data (
\family typewriter
xstar
\family default
) and derivative data (
\family typewriter
xstardot
\family default
) of the 
\family typewriter
i
\family default
-th reference signal (
\family typewriter
i
\family default
 = 1,..,
\family typewriter
n
\family default
).
 Each cell contains three column arrays (first = time instants, second =
 x component, third = y component), and each column has size 
\begin_inset Formula $\lfloor\frac{t_{max}-t_{min}}{h_{step}}\rfloor+1$
\end_inset

.
\end_layout

\begin_layout Subsection
Other outputs
\end_layout

\begin_layout Subsubsection
Figure
\end_layout

\begin_layout Standard
In 
\family typewriter
OFFLINE
\family default
 modes, a figure is opened, through call to 
\family typewriter
open_figure
\family default
 (see II.7).
 In mode 1, it simply displays the reference signal in red.
 In mode 2, for an arbitrary number of times, the user is able to draw an
 arbitrary continuous curve in the figure; at the end of each drawing, a
 message box is shown, asking the user if he/she wants to draw another signal.
\end_layout

\begin_layout Subsubsection
Message box
\end_layout

\begin_layout Standard
As described in 1.5.1.
\end_layout

\begin_layout Subsection
Throwable custom exceptions
\end_layout

\begin_layout Subsubsection
caller:ARG_ERROR
\end_layout

\begin_layout Itemize
Cause: a numeric parameter was not in the specified range.
\end_layout

\begin_layout Itemize
Error string: depends on the parameter.
\end_layout

\begin_layout Subsubsection
caller:MODE_ERROR
\end_layout

\begin_layout Itemize
Cause: the 
\family typewriter
mode
\family default
 parameter holds an invalid value, or 
\family typewriter
plot_mode
\family default
 and 
\family typewriter
mode
\family default
 are not compatible.
\end_layout

\begin_layout Itemize
Error string: 
\family typewriter
Given mode is not valid
\family default
 or 
\family typewriter
Mode and plot mode are not compatible
\family default
.
\end_layout

\begin_layout Subsubsection
caller:FIRST_POINT_NOT_REACHABLE_ERROR
\end_layout

\begin_layout Itemize
Cause: first point of at least one to-be-prepared simulation is not reachable
 by the robot.
\end_layout

\begin_layout Itemize
Error string: 
\family typewriter
['First point of reference signal ',num2str(ii),' is not reachable.']
\family default
, where 
\family typewriter
ii
\family default
 is the index of the indicted simulation.
\end_layout

\begin_layout Subsubsection
caller:INFINITE_SIGNAL_ERROR
\end_layout

\begin_layout Itemize
Cause: at least one point of at least one to-be-prepared simulation is not
 finite.
\end_layout

\begin_layout Itemize
Error string: 
\family typewriter
['Reference signal ',num2str(ii),' is not finite.']
\family default
, where 
\family typewriter
ii
\family default
 is the index of the indicted simulation.
\end_layout

\begin_layout Subsubsection
Others
\end_layout

\begin_layout Standard
All the exceptions throwable by 
\family typewriter
prepare_offline_given
\family default
, 
\family typewriter
prepare_offline_manual
\family default
, 
\family typewriter
plot_mode_str2int
\family default
 (see Part II).
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Section
start_simulation
\end_layout

\begin_layout Subsection
Definition
\end_layout

\begin_layout Standard

\family typewriter
function [sim_time, q1out, q2out, xout, yout, deltax, deltay] = start_simulation
 (sim_struct)
\end_layout

\begin_layout Subsection
Brief description
\end_layout

\begin_layout Standard
Runs the simulation(s) as indicated by the input structure.
 In 
\family typewriter
OFFLINE
\family default
 modes, there is no user interaction.
 In the 
\family typewriter
ONLINE
\family default
 mode, the user must draw (by cursor) an arbitrary number of signals to
 be followed in real time.
\end_layout

\begin_layout Subsection
Input parameters
\end_layout

\begin_layout Subsubsection
sim_struct
\end_layout

\begin_layout Standard
A structure as specified by the output of 
\family typewriter
prepare_simulation
\family default
 (see 1.4.1).
 Note that, as pointed out in 1.4.1, the last 7 fields (in the order seen
 in 1.4.1) are not necessary in 
\family typewriter
ONLINE
\family default
 mode (if they are provided, they will simply be ignored).
 If the output of a call to 
\family typewriter
prepare_simulation
\family default
 is given as input to 
\family typewriter
start_simulation
\family default
 (as it should be), there is no need to worry about this detail, as everything
 is handled automatically.
\end_layout

\begin_layout Subsection
Output parameters
\end_layout

\begin_layout Subsubsection
sim_time
\end_layout

\begin_layout Itemize
Column vector of doubles.
\end_layout

\begin_layout Itemize
Description: time associated with the simulation, which is the original
 signal time in mode 1 and the real simulation time in modes 2 and 3.
\end_layout

\begin_layout Subsubsection
q1out
\end_layout

\begin_layout Itemize
Column vector of doubles.
\end_layout

\begin_layout Itemize
Desctiption: array of values of the first generalized coordinate during
 the simulation.
\end_layout

\begin_layout Subsubsection
q2out
\end_layout

\begin_layout Itemize
Column vector of doubles.
\end_layout

\begin_layout Itemize
Desctiption: array of values of the second generalized coordinate during
 the simulation.
\end_layout

\begin_layout Subsubsection
xout
\end_layout

\begin_layout Itemize
Column vector of doubles.
\end_layout

\begin_layout Itemize
Desctiption: array of values of the first component of the actuator's position
 during the simulation.
\end_layout

\begin_layout Subsubsection
yout
\end_layout

\begin_layout Itemize
Column vector of doubles.
\end_layout

\begin_layout Itemize
Desctiption: array of values of the second component of the actuator's position
 during the simulation.
\end_layout

\begin_layout Subsubsection
deltax
\end_layout

\begin_layout Itemize
Column vector of doubles.
\end_layout

\begin_layout Itemize
Desctiption: array of values of the first component of 
\begin_inset Formula $\boldsymbol{\delta\mathbf{x}}$
\end_inset

 during the simulation.
\end_layout

\begin_layout Subsubsection
deltay
\end_layout

\begin_layout Itemize
Column vector of doubles.
\end_layout

\begin_layout Itemize
Desctiption: array of values of the second component of 
\begin_inset Formula $\boldsymbol{\delta\mathbf{x}}$
\end_inset

 during the simulation.
\end_layout

\begin_layout Subsection
Other outputs
\end_layout

\begin_layout Subsubsection
Figure
\end_layout

\begin_layout Standard
In 
\family typewriter
ONLINE
\family default
 mode, a figure is opened, through call to 
\family typewriter
open_figure
\family default
 (see II.7).
 For an arbitrary number of times, the user is able to draw an arbitrary
 continuous curve in the figure, and the robot (=Simulink model) follows
 it in real time; at the end of each drawing, a message box is shown, asking
 the user if he/she start a new simulation.
\end_layout

\begin_layout Subsubsection
Message boxes
\end_layout

\begin_layout Enumerate
The first kind is as described in 2.5.1.
\end_layout

\begin_layout Enumerate
After all simulations end, a message box containing the message 
\family typewriter
The simulation has ended successfully.

\family default
 is opened.
\end_layout

\begin_layout Subsection
Throwable custom exceptions
\end_layout

\begin_layout Subsubsection
caller:INVALID_STRUCT_ERROR
\end_layout

\begin_layout Itemize
Cause: an exception of type 
\family typewriter
MATLAB:nonExistentField
\family default
 or 
\family typewriter
MATLAB:structRefFromNonStruct
\family default
 was thrown, i.e.
 the input 
\family typewriter
sim_struct
\family default
 lacks some field or it was not a structure data type.
\end_layout

\begin_layout Itemize
Error string: 
\family typewriter
The argument sim_struct lacks at least one requested field.
\end_layout

\begin_layout Subsubsection
caller:ARG_ERROR
\end_layout

\begin_layout Itemize
Cause: a numeric parameter was not in the specified range.
\end_layout

\begin_layout Itemize
Error string: depends on the parameter.
\end_layout

\begin_layout Subsubsection
Others
\end_layout

\begin_layout Standard
All exceptions throwable by 
\family typewriter
compute_screen_parameters
\family default
 (see II.3.6).
\end_layout

\begin_layout Subsection
Notes
\end_layout

\begin_layout Itemize
A 
\family typewriter
FOR
\family default
 loop is used to loop through the simulations.
 In the 
\family typewriter
OFFLINE
\family default
 modes, the number of simulations is provided as the 
\family typewriter
n
\family default
 field of 
\family typewriter
sim_struct
\family default
; in the 
\family typewriter
ONLINE
\family default
 mode, such number is not known, so a 
\family typewriter
WHILE
\family default
 loop, with a 
\family typewriter
BREAK
\family default
 condition on local variable 
\family typewriter
no_more_simulations_needed
\family default
 becoming 1 (see next note), would be theoretically the most 
\begin_inset Quotes eld
\end_inset

clean
\begin_inset Quotes erd
\end_inset

 solution.
 However, to make the code more compact, it was decided to use a 
\family typewriter
FOR
\family default
 loop with an 
\begin_inset Quotes eld
\end_inset

infinite
\begin_inset Quotes erd
\end_inset

 number of loops (and the 
\family typewriter
BREAK
\family default
 condition stated above).
 However, such a loop raises the warning 
\family typewriter
Warning: Too many FOR loop iterations.
 Stopping after 9223372036854775806 iterations.
\family default
; since infinite loops are undoable anyway, it was then opted to use, as
 number of loops, the number indicated in the warning (9223372036854775806).
 However, the warning was still issued.
 The number used in the end was 922337203685477572 (which should be enough
 for all cases).
\end_layout

\begin_layout Itemize
A local variable, 
\family typewriter
no_more_simulations_needed
\family default
, is initialized to 0; the loop on the simulations has a 
\family typewriter
BREAK
\family default
 condition on 
\family typewriter
no_more_simulations_needed
\family default
 becoming 1.
 This change of value happens when the user refuses to run a new simulation,
 choosing 
\begin_inset Quotes eld
\end_inset

No
\begin_inset Quotes erd
\end_inset

 in the message box displayed by the MATLAB interpreted function 
\family typewriter
read_cursor_input
\family default
.
 When that happens, the instruction 
\family typewriter
assignin('caller', 'no_more_simulations_needed', 1);
\family default
 (executed in 
\family typewriter
read_cursor_input
\family default
) injects the value 1 into 
\family typewriter
no_more_simulations_needed
\family default
.
 Note that the use of function 
\family typewriter
assignin
\family default
 is discouraged as it is slow and hides data dependencies; however, as a
 special case it was choosen to use it for his compactness and the fact
 that it is executed at most once in the run of 
\family typewriter
starting_simulation
\family default
.
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Part
Internal functions documentation
\end_layout

\begin_layout Section
compute_screen_parameters
\end_layout

\begin_layout Subsection
Definition
\end_layout

\begin_layout Standard

\family typewriter
function [screen_width, screen_height, dist_left, dist_lower, dist_right,
 dist_upper]
\end_layout

\begin_layout Standard

\family typewriter
= compute_screen_parameters(f)
\end_layout

\begin_layout Subsection
Brief description
\end_layout

\begin_layout Standard
Computes some parameters that relate the input figure and the machine's
 screen.
\end_layout

\begin_layout Subsection
Input parameters
\end_layout

\begin_layout Subsubsection
f
\end_layout

\begin_layout Itemize
Type: figure handle.
\end_layout

\begin_layout Itemize
Description: an arbitrary figure handle.
\end_layout

\begin_layout Subsection
Output parameters
\end_layout

\begin_layout Subsubsection
screen_width
\end_layout

\begin_layout Itemize
Type: double.
\end_layout

\begin_layout Itemize
Description: width of the machine's screen.
\end_layout

\begin_layout Subsubsection
screen_height
\end_layout

\begin_layout Itemize
Type: double.
\end_layout

\begin_layout Itemize
Desctiption: height of the machine's screen.
\end_layout

\begin_layout Subsubsection
dist_left
\end_layout

\begin_layout Itemize
Type: double.
\end_layout

\begin_layout Itemize
Description: distance between the left border of the drawing area and the
 left border of the screen (as in Figure 1).
\end_layout

\begin_layout Standard
\begin_inset Float figure
placement H
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename fig1.png
	scale 50

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Value of dist_left.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
dist_lower
\end_layout

\begin_layout Itemize
Type: double.
\end_layout

\begin_layout Itemize
Description: distance between the lower border of the drawing area and the
 lower border of the screen.
\end_layout

\begin_layout Subsubsection
dist_right
\end_layout

\begin_layout Itemize
Type: double.
\end_layout

\begin_layout Itemize
Description: distance between the right border of the drawing area and the
 right border of the screen.
\end_layout

\begin_layout Subsubsection
dist_upper
\end_layout

\begin_layout Itemize
Type: double.
\end_layout

\begin_layout Itemize
Description: distance between the upper border of the drawing area and the
 upper border of the screen.
\end_layout

\begin_layout Subsection
Other outputs
\end_layout

\begin_layout Subsection
Throwable custom exceptions
\end_layout

\begin_layout Subsubsection
caller:DELETED_FIGURE_ERROR
\end_layout

\begin_layout Itemize
Cause: an 
\family typewriter
InvalidHandle
\family default
 exception has been thrown.
\end_layout

\begin_layout Itemize
Error string: 
\family typewriter
The figure (drawing area) must not be closed manually before the end of
 the running process.
\end_layout

\begin_layout Subsection
Where it is used
\end_layout

\begin_layout Enumerate
In online mode, at the first loop it is used by 
\family typewriter
start_simulation
\family default
 before the simulation begins (the output values are used in the Simulink
 model).
\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Section
exit_with_error
\end_layout

\begin_layout Subsection
Definition
\end_layout

\begin_layout Standard

\family typewriter
function exit_with_error(id, errstr)
\end_layout

\begin_layout Subsection
Brief description
\end_layout

\begin_layout Standard
Closes all open resources, clears persistent variables in other internal
 functions, opens a message box pointing the error out and throws an exception
 in function of the parameters.
\end_layout

\begin_layout Subsection
Input parameters
\end_layout

\begin_layout Subsubsection
id
\end_layout

\begin_layout Itemize
Type: string.
\end_layout

\begin_layout Itemize
Description: considering 
\family typewriter
caller:str2
\family default
 as the exception-to-be-thrown's identifier, this is 
\family typewriter
str2
\family default
.
\end_layout

\begin_layout Subsubsection
errstr
\end_layout

\begin_layout Itemize
Type: string.
\end_layout

\begin_layout Itemize
Description: the exception-to-be-thrown's error string.
\end_layout

\begin_layout Subsection
Output parameters
\end_layout

\begin_layout Subsection
Other outputs
\end_layout

\begin_layout Subsubsection
Message box
\end_layout

\begin_layout Standard
An error message box is opened in the user's screen.
 The title has the form 
\family typewriter
caller:id
\family default
; the message box text is 
\family typewriter
errstr
\family default
.
\end_layout

\begin_layout Subsection
Throwable custom exception
\end_layout

\begin_layout Subsubsection
caller:id
\end_layout

\begin_layout Itemize
Cause: call to 
\family typewriter
exit_with_error
\family default
.
\end_layout

\begin_layout Itemize
Error string: 
\family typewriter
errstr.
\end_layout

\begin_layout Subsection
Where it is used
\end_layout

\begin_layout Standard
Every procedure that needs to exit after an error uses this function.
\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Section
get_signals
\end_layout

\begin_layout Subsection
Definition
\end_layout

\begin_layout Standard

\family typewriter
function [xstar, xstardot, q1_initial, q2_initial] = get_signals(h_step,
 tmin, tmax, xs, ys, l1, l2, sw)
\end_layout

\begin_layout Subsection
Brief description
\end_layout

\begin_layout Standard
Converts 
\family typewriter
xs
\family default
 and 
\family typewriter
ys
\family default
, signals in a row vector format, into a 
\family typewriter
[time; xs'; ys']
\family default
 format, where 
\family typewriter
time
\family default
 is the time column vector.
 Also returns the derivatives of 
\family typewriter
xs
\family default
 and 
\family typewriter
ys
\family default
 in the same format and the initial angles needed for the signal.
\end_layout

\begin_layout Subsection
Inputs description
\end_layout

\begin_layout Subsubsection
h_step
\end_layout

\begin_layout Itemize
Type: double (positive).
\end_layout

\begin_layout Itemize
Description: sampling step of 
\family typewriter
xs
\family default
 and 
\family typewriter
ys
\family default
.
\end_layout

\begin_layout Subsubsection
tmin
\end_layout

\begin_layout Itemize
Type: double.
\end_layout

\begin_layout Itemize
Description: starting time of 
\family typewriter
xs
\family default
 and 
\family typewriter
ys
\family default
.
\end_layout

\begin_layout Subsubsection
tmax
\end_layout

\begin_layout Itemize
Type: double (greather than 
\family typewriter
tmin
\family default
).
\end_layout

\begin_layout Itemize
Description: final time of 
\family typewriter
xs
\family default
 and 
\family typewriter
ys
\family default
.
\end_layout

\begin_layout Subsubsection
xs
\end_layout

\begin_layout Itemize
Type: row vector of doubles of size equal to that of 
\family typewriter
ys
\family default
.
\end_layout

\begin_layout Itemize
Description: x component of the reference signal.
\end_layout

\begin_layout Subsubsection
ys
\end_layout

\begin_layout Itemize
Type: row vector of doubles of size equal to that of 
\family typewriter
xs
\family default
.
\end_layout

\begin_layout Itemize
Description: y component of the reference signal.
\end_layout

\begin_layout Subsubsection
l1
\end_layout

\begin_layout Itemize
Type: double (positive).
\end_layout

\begin_layout Itemize
Description: length of link 1 of the robot.
\end_layout

\begin_layout Subsubsection
l2
\end_layout

\begin_layout Itemize
Type: double (positive).
\end_layout

\begin_layout Itemize
Description: length of link 2 of the robot.
\end_layout

\begin_layout Subsubsection
sw
\end_layout

\begin_layout Itemize
Type: integer (can be -1, 1 or 2).
\end_layout

\begin_layout Itemize
Description: simulation switching parameter.
\end_layout

\begin_layout Subsection
Output parameters
\end_layout

\begin_layout Subsubsection
xstar
\end_layout

\begin_layout Itemize
Type: matrix of doubles.
\end_layout

\begin_layout Itemize
Description: 
\family typewriter
[t xs' ys']
\family default
 where 
\family typewriter
t=(tmin:h:tmax)
\family default
'.
\end_layout

\begin_layout Subsubsection
xstardot
\end_layout

\begin_layout Itemize
Type: matrix of doubles.
\end_layout

\begin_layout Itemize
Description: 
\family typewriter
[t xsd' ysd']
\family default
 where 
\family typewriter
t=(tmin:h:tmax)
\family default
', and 
\family typewriter
[xsd ysd]
\family default
 is the numerical derivative of 
\family typewriter
[xs ys]
\family default
, computed with Euler's method.
\end_layout

\begin_layout Subsubsection
q1_initial
\end_layout

\begin_layout Itemize
Type: double
\end_layout

\begin_layout Itemize
Desctiption: initial value of q1 for the reference signal.
\end_layout

\begin_layout Subsubsection
q2_initial
\end_layout

\begin_layout Itemize
Type: double
\end_layout

\begin_layout Itemize
Desctiption: initial value of q2 for the reference signal.
\end_layout

\begin_layout Subsection
Other outputs
\end_layout

\begin_layout Subsection
Throwable custom exceptions
\end_layout

\begin_layout Subsubsection
caller:INVALID_INPUT_SIZE_ERROR
\end_layout

\begin_layout Itemize
Cause: parameter sizes are not compatible.
\end_layout

\begin_layout Itemize
Error string: 
\family typewriter
At least one component of the given reference signal has invalid dimension.
 Each component must be a row vector with floor((tmax-tmin)/h)+1 columns.
\end_layout

\begin_layout Subsection
Where it is used
\end_layout

\begin_layout Standard
In 
\family typewriter
prepare_offline_given
\family default
 (to convert the user input into the correct format) and in 
\family typewriter
prepare_offline_manual
\family default
 (to convert the 
\family typewriter
drawfreehand
\family default
 output into the correct format).
\end_layout

\begin_layout Subsection
Notes
\end_layout

\begin_layout Itemize
When executing the instruction 
\family typewriter
b=diff(a)
\family default
, where 
\family typewriter
a
\family default
 is an array of size 
\family typewriter
n
\family default
, 
\family typewriter
b
\family default
 turns out to have 
\family typewriter
n - 1
\family default
 elements.
 This is because the 
\family typewriter
i
\family default
-th element of 
\family typewriter
b
\family default
 is computed as 
\family typewriter
b(i) = a(i+1)-a(i)
\family default
, and there is no 
\family typewriter
n + 1
\family default
-th element to use.
 Because of this, the last element of 
\family typewriter
xsd
\family default
 and 
\family typewriter
ysd
\family default
 is computed separately: if the reference signal has more than one sample,
 we use a backwards formula, 
\family typewriter
b(n) = a(n)-a(n-1)
\family default
; otherwise, the signal was a constant anyway, so we set the last (and only)
 element to 0.
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Section
get_simulation_results
\end_layout

\begin_layout Subsection
Definition
\end_layout

\begin_layout Standard

\family typewriter
function [sim_time, q1out, q2out, xout, yout, deltax, deltay] = get_simulation_r
esults(sw, q1q2, outs)
\end_layout

\begin_layout Subsection
Brief description
\end_layout

\begin_layout Standard
Takes the simulation results in the original Simulink format and converts
 them into a column vector format.
\end_layout

\begin_layout Subsection
Input parameters
\end_layout

\begin_layout Subsubsection
sw
\end_layout

\begin_layout Itemize
Type: integer (can be -1, 1 or 2).
\end_layout

\begin_layout Itemize
Description: simulation switching parameter.
\end_layout

\begin_layout Subsubsection
q1q2
\end_layout

\begin_layout Itemize
Type: Simulink signal structure with two signals.
\end_layout

\begin_layout Itemize
Description: robot generalized coordinates during the simulation.
\end_layout

\begin_layout Subsubsection
outs
\end_layout

\begin_layout Itemize
Type: Simulink signal structure with six signals.
\end_layout

\begin_layout Itemize
Description: components of actuator position, components of 
\begin_inset Formula $\mathbf{\boldsymbol{\delta}x}$
\end_inset

, simulation variable 
\family typewriter
starting_time
\family default
, and real time of the simulation.
\end_layout

\begin_layout Subsection
Output parameters
\end_layout

\begin_layout Standard
The output are those of 
\family typewriter
start_simulation
\family default
 (see I.2.4).
\end_layout

\begin_layout Subsection
Other outputs
\end_layout

\begin_layout Subsection
Throwable exceptions
\end_layout

\begin_layout Subsection
Where it is used
\end_layout

\begin_layout Standard
In 
\family typewriter
start_simulation
\family default
, after the end of each simulation.
\end_layout

\begin_layout Subsection
Notes
\end_layout

\begin_layout Itemize
Call 
\family typewriter
sim_time_arr
\family default
 the array of simulation times.
 In 
\family typewriter
OFFLINE
\family default
 modes, the values of the signals during the whole simulation run have to
 be returned.
 On the other hand, in 
\family typewriter
ONLINE
\family default
 mode, the results that are to be considered are those after the initial
 conditions have been reached; in this case, therefore, the only values
 that will be returned are those with index 
\begin_inset Formula $\ge$
\end_inset

 
\family typewriter
first_time_index
\family default
, where 
\family typewriter
first_time_index
\family default
 is such that 
\family typewriter
sim_time_arr(first_time_index)
\family default
 is equal to the instant where the initial conditions are reached.
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Section
open_figure
\end_layout

\begin_layout Subsection
Definition
\end_layout

\begin_layout Standard

\family typewriter
function f = open_figure(sw, l1, l2)
\end_layout

\begin_layout Subsection
Brief description
\end_layout

\begin_layout Standard
Closes all open figures, opens and returns a new figure after applying some
 customization for the simulation (see below).
\end_layout

\begin_layout Subsection
Input parameters
\end_layout

\begin_layout Subsubsection
sw
\end_layout

\begin_layout Itemize
Type: integer (can be -1, 1 or 2).
\end_layout

\begin_layout Itemize
Description: simulation switching parameter.
\end_layout

\begin_layout Subsubsection
l1
\end_layout

\begin_layout Itemize
Type: double (positive).
\end_layout

\begin_layout Itemize
Description: length of link 1 of the robot.
\end_layout

\begin_layout Subsubsection
l2
\end_layout

\begin_layout Itemize
Type: double (positive).
\end_layout

\begin_layout Itemize
Description: length of link 2 of the robot.
\end_layout

\begin_layout Subsection
Output parameters
\end_layout

\begin_layout Subsubsection
f
\end_layout

\begin_layout Itemize
Type: figure handle.
\end_layout

\begin_layout Itemize
Description: handles a figure with axis limits 
\family typewriter
[-(l1+l2), l1+l2]
\family default
 in both coordinates, maximized dimension, square shape if not in online
 mode, 
\family typewriter
hold on
\family default
 active, grid, pixel as axes units.
 Furthermore, two (one if 
\family typewriter
l1 = l2
\family default
) circles are drawn in black, respectively with radius 
\family typewriter
l1 + l2
\family default
 and 
\family typewriter
abs(l1 - l2)
\family default
.
\end_layout

\begin_layout Subsection
Other outputs
\end_layout

\begin_layout Subsubsection
f
\end_layout

\begin_layout Standard

\family typewriter
f
\family default
 is opened as well as returned.
\end_layout

\begin_layout Subsection
Throwable exceptions
\end_layout

\begin_layout Subsection
Where it is used
\end_layout

\begin_layout Enumerate
In 
\family typewriter
start_simulation
\family default
, 
\family typewriter
prepare_offline_given
\family default
, 
\family typewriter
prepare_offline_manual
\family default
, it is called in order to open the simulation figure for the first time.
\end_layout

\begin_layout Enumerate
In 
\family typewriter
plot_robot_position
\family default
 and 
\family typewriter
start_simulation
\family default
, it is called if it turns out the figure has been closed during simulation,
 and must be re-opened.
\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Section
plot_mode_str2int
\end_layout

\begin_layout Subsection
Definition
\end_layout

\begin_layout Standard

\family typewriter
function plot_mode = plot_mode_str2int(plot_mode)
\end_layout

\begin_layout Subsection
Brief description
\end_layout

\begin_layout Standard
Converts a valid plot mode string into an integer value.
\end_layout

\begin_layout Subsection
Input parameters
\end_layout

\begin_layout Subsubsection
plot_mode
\end_layout

\begin_layout Itemize
Type: string (valid values: 
\family typewriter
NO_PLOT
\family default
, 
\family typewriter
PLOT_NO_LINKS
\family default
, 
\family typewriter
PLOT_WITH_LINKS
\family default
).
\end_layout

\begin_layout Itemize
Description: 
\family typewriter
NO_PLOT
\family default
 if no plot is desired during the simulation, 
\family typewriter
PLOT_NO_LINKS
\family default
 if only the plot of the robot position is wanted, 
\family typewriter
PLOT_WITH_LINKS
\family default
 if at each step the drawing of the robot links are wanted.
\end_layout

\begin_layout Subsection
Output parameters
\end_layout

\begin_layout Subsubsection
plot_mode
\end_layout

\begin_layout Itemize
Integer.
\end_layout

\begin_layout Itemize
Description: 0 if input = 
\family typewriter
NO_PLOT
\family default
, 1 if input = 
\family typewriter
PLOT_NO_LINKS
\family default
, 2 if input = 
\family typewriter
PLOT_WITH_LINKS
\family default
.
\end_layout

\begin_layout Subsection
Other outputs
\end_layout

\begin_layout Subsection
Throwable custom exceptions
\end_layout

\begin_layout Subsubsection
caller:PLOT_MODE_ERROR
\end_layout

\begin_layout Itemize
Cause: input has an invalid value.
\end_layout

\begin_layout Itemize
Error string: 
\family typewriter
Given plot mode is not valid
\family default
.
\end_layout

\begin_layout Subsection
Where it is used
\end_layout

\begin_layout Standard
At the beginning of 
\family typewriter
prepare_simulation
\family default
.
\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Section
pos2angle
\end_layout

\begin_layout Subsection
Definition
\end_layout

\begin_layout Standard

\family typewriter
function [q1, q2] = pos2angle (x, y, l1, l2)
\end_layout

\begin_layout Subsection
Brief description
\end_layout

\begin_layout Standard
Given the actuator position and the length of the links, the corresponding
 robot angles are returned.
\end_layout

\begin_layout Subsection
Input parameters
\end_layout

\begin_layout Subsubsection
x
\end_layout

\begin_layout Itemize
Type: double.
\end_layout

\begin_layout Itemize
Desctiption: first component of actuator's position.
\end_layout

\begin_layout Subsubsection
y
\end_layout

\begin_layout Itemize
Type: double.
\end_layout

\begin_layout Itemize
Desctiption: second component of actuator's position.
\end_layout

\begin_layout Subsubsection
l1
\end_layout

\begin_layout Itemize
Type: double (positive).
\end_layout

\begin_layout Itemize
Desctiption: length of link 1 of the robot.
\end_layout

\begin_layout Subsubsection
l2
\end_layout

\begin_layout Itemize
Type: double (positive).
\end_layout

\begin_layout Itemize
Desctiption: length of link 2 of the robot.
\end_layout

\begin_layout Subsection
Output parameters
\end_layout

\begin_layout Subsubsection
q1
\end_layout

\begin_layout Itemize
Type: double.
\end_layout

\begin_layout Itemize
Description: first generalized coordinate associated with 
\family typewriter
(x, y
\family default
).
\end_layout

\begin_layout Subsubsection
q2
\end_layout

\begin_layout Itemize
Type: double.
\end_layout

\begin_layout Itemize
Description: second generalized coordinate associated with 
\family typewriter
(x, y
\family default
).
\end_layout

\begin_layout Subsection
Other outputs
\end_layout

\begin_layout Subsection
Throwable custom exceptions
\end_layout

\begin_layout Subsection
Where it is used
\end_layout

\begin_layout Standard
In 
\family typewriter
get_signals
\family default
 and 
\family typewriter
read_cursor_input
\family default
, in order to compute the initial conditions for the Simulink model (if
 
\family typewriter
x
\family default
, 
\family typewriter
y
\family default
 are reachable).
\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Section
prepare_offline_given
\end_layout

\begin_layout Subsection
Definition
\end_layout

\begin_layout Standard

\family typewriter
function [n, q1_initial, q2_initial, xstar, xstardot, sw]
\end_layout

\begin_layout Standard

\family typewriter
= prepare_offline_given(l1, l2, h_step, tmin, tmax, xs, ys, plot_mode)
\end_layout

\begin_layout Subsection
Brief description
\end_layout

\begin_layout Standard
In 
\family typewriter
OFFLINE_GIVEN
\family default
 mode, assigns 1 to n and 
\family typewriter
sw
\family default
 and computes the other output parameters through a call to 
\family typewriter
get_signals
\family default
.
 Afterwards, it opens a figure and plots the reference signal in red.
\end_layout

\begin_layout Subsection
Input, output parameters
\end_layout

\begin_layout Standard
Input and output parameters are those of 
\family typewriter
prepare_sim
\family default
, from where this function is called in case the 
\family typewriter
OFFLINE_GIVEN
\family default
 mode is requested.
\end_layout

\begin_layout Subsection
Other outputs
\end_layout

\begin_layout Subsubsection
Figure
\end_layout

\begin_layout Standard
A figure is opened through a call to 
\family typewriter
open_figure
\family default
.
 The reference signal is plotted on it in red, as an xy curve.
\end_layout

\begin_layout Subsection
Throwable custom exceptions
\end_layout

\begin_layout Subsubsection
caller:ARG_ERROR
\end_layout

\begin_layout Itemize
Cause: 
\family typewriter
tmin > tmax
\family default
.
\end_layout

\begin_layout Itemize
Error string: 
\family typewriter
tmin cannot be greater than tmax.
\end_layout

\begin_layout Subsubsection
Other
\end_layout

\begin_layout Standard
The exceptions throwable in 
\family typewriter
get_signals
\family default
 can be thrown.
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Section
prepare_offline_manual
\end_layout

\begin_layout Subsection
Definition
\end_layout

\begin_layout Standard

\family typewriter
function [n, q1_initial, q2_initial, tmin, tmax, xstar, xstardot, sw]
\end_layout

\begin_layout Standard

\family typewriter
= prepare_offline_manual(l1, l2)
\end_layout

\begin_layout Subsection
Brief description
\end_layout

\begin_layout Standard
In 
\family typewriter
OFFLINE_MANUAL
\family default
 mode, opens a figure and lets the user draw an arbitrary number of continuous
 curves by using the 
\family typewriter
drawfreehand
\family default
 function.
 At the end of each drawing, a message asks the user if he/she wants to
 draw another curve.
 The number of simulations and 1, respectively, are assigned to 
\family typewriter
n
\family default
 and 
\family typewriter
sw
\family default
.
\end_layout

\begin_layout Subsection
Input, output parameters
\end_layout

\begin_layout Standard
Input and output parameters are those of 
\family typewriter
prepare_sim
\family default
, from where this function is called in case the 
\family typewriter
OFFLINE_MANUAL
\family default
 mode is requested.
\end_layout

\begin_layout Subsection
Other outputs
\end_layout

\begin_layout Subsubsection
Figure
\end_layout

\begin_layout Standard
A figure is opened through call to 
\family typewriter
open_figure
\family default
 if 
\family typewriter
plot_mode
\family default
 is positive.
\end_layout

\begin_layout Subsubsection
Message box
\end_layout

\begin_layout Standard
At the end of each drawing, a message box asks the user if he/she wants
 to draw another curve.
\end_layout

\begin_layout Subsection
Throwable custom exceptions
\end_layout

\begin_layout Subsubsection
caller:DELETED_FIGURE_ERROR
\end_layout

\begin_layout Itemize
Cause: a 
\family typewriter
MATLAB:class:InvalidHandle
\family default
 exception is thrown by the 
\family typewriter
drawfreehand
\family default
 function as a result of closing the figure during the drawing process.
\end_layout

\begin_layout Itemize
Error string: 
\family typewriter
The figure (drawing area) must not be closed manually before the end of
 the running process.
\end_layout

\begin_layout Subsubsection
Others
\end_layout

\begin_layout Standard
The exceptions throwable in 
\family typewriter
get_signals
\family default
 can be thrown.
\end_layout

\begin_layout Subsection
Notes
\end_layout

\begin_layout Itemize
To obtain the curve drawn by the user, a call to 
\family typewriter
drawfreehand
\family default
, a MATLAB system function, is performed.
 Since this function returns all the plotted points after the call has terminate
d, i.e.
 after the plot is completed, it could not be used in the 
\family typewriter
ONLINE
\family default
 mode, where the drawn points are needed as soon as possible by the simulator.
 However, it was decided to use it here, and not to use the custom routine
 implemented for the 
\family typewriter
ONLINE
\family default
 mode, as 
\family typewriter
drawfreehand
\family default
 is more precise and more performing.
\end_layout

\begin_layout Itemize
If the figure is closed during the simulation, 
\family typewriter
drawfreehand
\family default
 returns a null object; therefore the process has to be stopped with error
 (see 11.5.1).
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Part
Simulink model documentation
\end_layout

\begin_layout Standard
After an introduction, each of the following sections is associated to an
 area of the Simulink model.
\end_layout

\begin_layout Section
Introduction
\end_layout

\begin_layout Standard
The model uses a set of variables; each one is associated to a GOTO block.
 In particular, 
\family typewriter
l1
\family default
, 
\family typewriter
l2
\family default
, 
\family typewriter
sw
\family default
, 
\family typewriter
vmax
\family default
, 
\family typewriter
tmin
\family default
, 
\family typewriter
plot_mode
\family default
 are used in all modes with obvious role.
\end_layout

\begin_layout Standard
The variable 
\family typewriter
starting_time
\family default
 is computed at every step in the Achievement of initial position area,
 and holds value 
\family typewriter
tmin
\family default
 in 
\family typewriter
OFFLINE
\family default
 modes; in 
\family typewriter
ONLINE
\family default
 mode, it has value -1 before the initial conditions are reached, and their
 time of achievement afterwards.
\end_layout

\begin_layout Standard
The variable 
\family typewriter
reset
\family default
 is computed at every step in the Reference signal acquisition area, and
 is always valued 0 in 
\family typewriter
OFFLINE
\family default
 modes.
 In 
\family typewriter
ONLINE
\family default
 mode, it is valued 0 before the user has started drawing, and 1 afterwards.
\end_layout

\begin_layout Standard
The variable 
\family typewriter
ended
\family default
 is computed at every step in the Reference signal acquisition area, and
 is valued 0 before the simulation has ended, 1 afterwards.
 Since the non-abnormal end of the simulation is issued as an input of 1
 to the 
\family typewriter
STOP
\family default
 block, this parameter can be used by the other areas in the remaining execution
 of the last step of simulation.
\end_layout

\begin_layout Standard
IMPORTANT: the Simulink model is run from the 
\family typewriter
start_simulation
\family default
 function (through a call to the 
\family typewriter
sim
\family default
 function), and the simulation parameters, including the simulation step,
 are given as parameters there.
 HOWEVER, don't put different settings in the Simulink configuration parameters
 settings.
 For example, calling 
\family typewriter
sim
\family default
 with a fixed step parameter AND setting the solver to 
\family typewriter
auto
\family default
 in the solver configuration parameters settings will cause Simulink to
 set as actual simulation step the GCD of the 
\family typewriter
sim
\family default
 parameter and a Simulink-generated step.
 This WILL cause confusion, so be careful.
\end_layout

\begin_layout Section
Initial assignments area
\end_layout

\begin_layout Standard
\begin_inset Float figure
placement h
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename simulink1assign.png
	scale 55

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Initial assignments8 area.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
In this area several parameters (
\family typewriter
l1
\family default
, 
\family typewriter
l2
\family default
, 
\family typewriter
q1ws
\family default
, 
\family typewriter
q2ws
\family default
, 
\family typewriter
clock
\family default
, 
\family typewriter
plot_mode
\family default
, 
\family typewriter
sw
\family default
, 
\family typewriter
current_tmin
\family default
 and all the screen parameters) from the workspace are assigned to a 
\family typewriter
GOTO
\family default
 block.
 This way, if one or moreof those parameters get their name changed in a
 future development of the software, the model has to be changed in one
 place only.
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Section
Reference signal acquisition area
\end_layout

\begin_layout Standard
\begin_inset Float figure
placement H
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename simulink2refac.png
	scale 65

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Reference signal acquisition.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
The 
\family typewriter
ref_acquisition 
\family default
subsystem is composed of three areas: the Online reference processing area,
 the Choice of Reference area and the vmax computation area.
\end_layout

\begin_layout Subsection
Online reference processing area
\end_layout

\begin_layout Standard
\begin_inset Float figure
placement H
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename simulink2refac_online.png
	scale 45

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout

\family typewriter
ref_acquisition
\family default
 subsystem.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
In 
\family typewriter
ONLINE
\family default
 mode, this area reads and stores the cursor input in the 
\family typewriter
GOTO
\family default
 block 
\family typewriter
ref_by_hand
\family default
, as well as assigning a few other variables (see 1.4.1.1).
\end_layout

\begin_layout Subsubsection
MATLAB interpreted function read_cursor_input
\end_layout

\begin_layout Paragraph
Definition
\end_layout

\begin_layout Standard
\noindent

\family typewriter
function out = read_cursor_input (in)
\family default
.
\end_layout

\begin_layout Paragraph
Output parameters
\end_layout

\begin_layout Standard
\noindent
The output signal 
\family typewriter
out
\family default
 is a column array of size 6.
 In 
\family typewriter
OFFLINE
\family default
 modes, this function is not used, therefore the outputs always have a value
 of 0.
 In 
\family typewriter
ONLINE
\family default
 mode, its elements are the following (listed from first to last):
\end_layout

\begin_layout Itemize
\noindent

\family typewriter
xstar
\family default
, 
\family typewriter
ystar
\family default
 = zero vector before the user starts drawing; the two components of the
 reference signal, provided by the user through the use of the cursor, afterward
s.
\end_layout

\begin_layout Itemize
\noindent

\family typewriter
q1i
\family default
, 
\family typewriter
q2i
\family default
 = respectively 0 and 4 (arbitrary values) before the user starts drawing;
 the initial angles associated with the reference signal drawn by the user
 after the user has started drawing.
\end_layout

\begin_layout Itemize
\noindent

\family typewriter
RESET
\family default
 = 0 before the user starts drawing, 1 afterwards.
 The change of value of this variable happens the first time that the mouse
 results clicked and the clicked point is inside the drawing area.
\end_layout

\begin_layout Itemize
\noindent

\family typewriter
ended
\family default
 = 0 before the simulation has terminated, 1 afterwards.
 The change of value of this variable happens if the mouse is not clicked
 and 
\family typewriter
RESET
\family default
 is equal to 1, i.e.
 the mouse has been released by the user.
\end_layout

\begin_layout Itemize

\family typewriter
real_step
\family default
 = 0 in 
\family typewriter
OFFLINE
\family default
 modes; in 
\family typewriter
ONLINE
\family default
 mode, it is equal to the difference of the time at which the latest point
 was drawn and the time at which the previous point was drawn.
\end_layout

\begin_layout Paragraph
\noindent
Other outputs
\end_layout

\begin_layout Standard
\noindent
After the user has started drawing, i.e.
 when 
\family typewriter
RESET > 0
\family default
, the points provided by the user through the cursor are plotted in red
 on the opened simulation figure.
\end_layout

\begin_layout Paragraph
Custom exceptions
\end_layout

\begin_layout Standard
\noindent
An exception of id 
\family typewriter
caller:FIRST_POINT_NOT_REACHABLE_ERROR
\family default
 and error string 
\family typewriter
First point of the reference signal is not reachable.

\family default
 can be thrown if the first point plotted by the user is outside of the
 reachability space.
\end_layout

\begin_layout Paragraph
Note
\end_layout

\begin_layout Standard
At implementation time, a convenient way to capture the position of the
 cursor at each instant was seeked.
 Consider the command 
\family typewriter
get(gca, 'CurrentPoint');
\family default
; it returns the cursor's coordinates with respect to the current axes,
 but only returns the last clicked or unclicked point, ignoring the points
 over which the cursor hovered.
 Oddly enough, the command 
\family typewriter
get(0, 'PointerLocation');
\family default
 returns the points with respect to the screen coordinates, but at all times,
 not only when the user clicks or unclicks.
 The second instruction is therefore used; however, the obtained point must
 be converted to the figure/axes coordinates, and this is the reason for
 which the values computed by 
\family typewriter
compute_screen_parameters
\family default
 are provided as input to 
\family typewriter
read_cursor_input
\family default
.
 The formulas to convert the points were obtained through a simple transformatio
n of coordinates.
\end_layout

\begin_layout Standard
For instance, consider the x coordinate.
 Define 
\begin_inset Formula $L\coloneqq l_{1}+l_{2}$
\end_inset

, 
\begin_inset Formula $d_{L}\coloneqq$
\end_inset

 
\family typewriter
dist_left
\family default
, 
\begin_inset Formula $d_{R}\coloneqq$
\end_inset

 
\family typewriter
dist_right
\family default
, 
\begin_inset Formula $w\coloneqq$
\end_inset


\family typewriter
screen_width
\family default
.
 To transform the value 
\begin_inset Formula $x_{s}$
\end_inset

 (relative to screen coordinates) to 
\begin_inset Formula $x_{a}$
\end_inset

 (relative to axes coordinates), we need the straight line going through
 the points (
\begin_inset Formula $x_{s}=d_{L}$
\end_inset

, 
\begin_inset Formula $x_{a}=-2L$
\end_inset

) and (
\begin_inset Formula $x_{s}=w-d_{R}$
\end_inset

, 
\begin_inset Formula $x_{a}=2L$
\end_inset

), that is, the straight line satisfying the equations
\end_layout

\begin_layout Standard
\align center
\begin_inset Formula $-2L=m_{x}d_{L}+q_{x}$
\end_inset


\end_layout

\begin_layout Standard
\align center
\begin_inset Formula $2L=m_{x}(w-d_{R})+q_{x}$
\end_inset


\end_layout

\begin_layout Standard
Solving for 
\begin_inset Formula $m_{x}$
\end_inset

 and 
\begin_inset Formula $q_{x}$
\end_inset

 easily gives 
\begin_inset Formula $m_{x}=\frac{4L}{w-d_{R}-d_{L}},q_{x}=-2L-\frac{4L}{w-d_{R}-d_{L}}d_{L}$
\end_inset

, which are the relationships used in the program (rearranged in order to
 avoid multiple computations of 
\begin_inset Formula $\frac{4L}{w-d_{R}-d_{L}}$
\end_inset

).
 For the y coordinate, an analogous procedure (or noticing the simmetry
 of the problem) yields 
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none

\begin_inset Formula $m_{y}=\frac{4L}{h-d_{D}-d_{U}},q_{y}=-2L-\frac{4L}{h-d_{D}-d_{U}}d_{D}$
\end_inset

, where 
\begin_inset Formula $h$
\end_inset

 = 
\family typewriter
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit
screen_height
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
, 
\begin_inset Formula $d_{D}$
\end_inset

 = 
\family typewriter
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit
dist_lower
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
, 
\begin_inset Formula $d_{U}$
\end_inset

 = 
\family typewriter
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit
dist_upper
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
.
\end_layout

\begin_layout Subsection
Choice of reference area
\end_layout

\begin_layout Standard
\begin_inset Float figure
placement H
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename simulink2refac_choice.png
	scale 50

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Choice of reference area.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
In 
\family typewriter
ONLINE
\family default
 mode, this area assigns the 
\family typewriter
ref_by_hand 
\family default
signal (the cursor input) to 
\family typewriter
xstar
\family default
; in 
\family typewriter
OFFLINE
\family default
 modes, the 
\family typewriter
n
\family default
-th cell of 
\family typewriter
xstar
\family default
 (workspace variable) is assigned instead.
\end_layout

\begin_layout Subsection
vmax computation area
\end_layout

\begin_layout Standard
\begin_inset Float figure
placement H
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename simulink2refac_vmax.png
	scale 60

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
vmax computation area.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
In 
\family typewriter
OFFLINE
\family default
 modes, vmax is simply imported from the workspace.
\end_layout

\begin_layout Standard
In 
\family typewriter
ONLINE
\family default
 mode, it is multiplied by the positive quantity 
\family typewriter
real_step/h_step
\family default
.
 This is because the internal clock of the simulation is 
\family typewriter
h_step
\family default
, but the actual step time at each simulation pass 
\family typewriter
real_step
\family default
.
 (usually 
\family typewriter
h_step < real_step
\family default
).
 The maximum speed in m/s is 
\family typewriter
vmax
\family default
; if one simulation step corresponded with one real second, we'd simply
 have to divide by 
\family typewriter
h_step
\family default
; however, one simulation step corresponds to one real step, i.e.
 it contains 
\family typewriter
real_step
\family default
 seconds.
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Section
xstardot computation area
\end_layout

\begin_layout Standard
\begin_inset Float figure
placement H
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename simulink3xstardot.png
	scale 60

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
xstardot computation area.
\end_layout

\end_inset


\end_layout

\end_inset

This area selects the derivative of the reference.
 If 
\family typewriter
sw
\family default
 > 0, the n-th element of the workspace cell array 
\family typewriter
xstardot
\family default
 is trivially chosen.
 In the other case, it is more complicated.
\end_layout

\begin_layout Standard
For now, ignore the delay block.
 Before 
\family typewriter
RESET
\family default
 is set to a positive value, i.e.
 before the user has started drawing, a null derivative is provided (any
 finite signal would do, as this part is going to be ignored).
 Roughly after 
\family typewriter
RESET
\family default
 changes sign, a saturated version of the derivative of the hand(cursor)-drawn
 reference signal is provided instead.
\end_layout

\begin_layout Standard
The saturation allows the simulation not to crash on the user when the latter
 exceeds the maximum speed of the robot (however, the robot will proceed
 at its maximum velocity, forcing the user to slow down).
 Finally, the delay block is necessary because, when the user starts drawing,
 a jump will happen, i.e.
 the derivative of the cursor-drawn signal will be very high.
 We want the robot to start as still, so we provide null derivative for
 a few more time steps.
\end_layout

\begin_layout Section
qdot computation area
\end_layout

\begin_layout Standard
\begin_inset Float figure
placement h
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename simulink4qdot.png
	scale 50

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
qdot computation area.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
The 
\family typewriter
qdot_computation
\family default
 subsystem faithfully implements the robot control logic seen in the introductio
n.
 Internally, it has three areas: the Inversion of J area, the K
\begin_inset Formula $\times$
\end_inset

Deltax computation area and the Final computation area.
\end_layout

\begin_layout Standard
\begin_inset Float figure
placement h
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename simulink4qdot_sub.png
	scale 45

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
qdot_computation subsystem
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
As said, the calculations are those explained in the introduction.
\end_layout

\begin_layout Subsubsection
Interpreted MATLAB function invert_J
\end_layout

\begin_layout Standard
If inputs 
\family typewriter
xstar
\family default
, 
\family typewriter
ystar
\family default
, 
\family typewriter
xstardot
\family default
 and 
\family typewriter
ystardot
\family default
 specify a valid signal (that is, not exceeding maximum speed 
\family typewriter
vmax
\family default
 and being reachable), the output is the inverse of the Jacobian of the
 system.
 Otherwise, an exception is thrown; it can be of two types:
\end_layout

\begin_layout Enumerate
id = 
\family typewriter
caller:MAX_SPEED_EXCEEDED_ERROR
\family default
, error text = 
\family typewriter
Maximum speed exceeded.
\end_layout

\begin_layout Enumerate
id = 
\family typewriter
caller:POINT_NOT_REACHABLE_ERROR
\family default
, error text = 
\family typewriter
Point is not reachable.
\end_layout

\begin_layout Section
Arm area
\end_layout

\begin_layout Standard
\begin_inset Float figure
placement h
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename simulink5arm.png
	scale 60

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Arm area.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
The Arm subsystem uses 
\family typewriter
qdot
\family default
, computed in the qdot computation area, to calculate the actuator's position
 (multiplexed into 
\family typewriter
xy
\family default
) and the associated angles (multiplexed into 
\family typewriter
q
\family default
).
\end_layout

\begin_layout Subsection
Arm subsystem
\end_layout

\begin_layout Standard
\begin_inset Float figure
placement H
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename simulink5armarm.png
	scale 50

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Arm subsystem.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Initial conditions areas
\end_layout

\begin_layout Standard
The two leftmost areas select the correct initial angles.
 If 
\family typewriter
sw
\family default
 > 0, i.e.
 the simulation is in an 
\family typewriter
OFFLINE
\family default
 mode, the signals 
\family typewriter
q1i
\family default
 and 
\family typewriter
q2i
\family default
, computed during the simulation in the Reference signal acquisition area,
 are chosen.
 Otherwise, the signals 
\family typewriter
q1iws
\family default
 and 
\family typewriter
q2iws
\family default
, computed before the simulation in the workspace, are chosen.
\end_layout

\begin_layout Subsubsection
Angles computation
\end_layout

\begin_layout Standard
The remaining areas perform the integration of the derivatives of 
\family typewriter
q1
\family default
 and 
\family typewriter
q2
\family default
, in order to obtain 
\family typewriter
q1
\family default
 and 
\family typewriter
q2
\family default
, which are then returned as third and fourth outputs.
\end_layout

\begin_layout Standard
The integrators reset to the initial condition signals 
\family typewriter
q1_init
\family default
 and 
\family typewriter
q2_init
\family default
 when the signal 
\family typewriter
RESET
\family default
 changes sign; in the 
\family typewriter
OFFLINE
\family default
 modes this never happens, while in the 
\family typewriter
ONLINE
\family default
 mode this happens after the user has started drawing, and 
\family typewriter
q1_init
\family default
, 
\family typewriter
q2_init
\family default
 have been assigned to the needed initial angles by the 
\family typewriter
read_user_input
\family default
 function (see 17.1).
\end_layout

\begin_layout Subsubsection
Actuator position area
\end_layout

\begin_layout Standard
This area outputs the components of the actuator's position, 
\family typewriter
x
\family default
 and 
\family typewriter
y
\family default
, after being computed from the angles 
\family typewriter
q1
\family default
 and 
\family typewriter
q2
\family default
 according to the relationships
\end_layout

\begin_layout Standard
\align center
\begin_inset Formula $x=l_{1}\mathrm{cos}q_{1}+l_{2}\mathrm{cos}(q_{1}+q_{2})$
\end_inset


\end_layout

\begin_layout Standard
\align center
\begin_inset Formula $y=l_{1}\mathrm{sin}q_{1}+l_{2}\mathrm{sin}(q_{1}+q_{2})$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Section
Time handling area
\end_layout

\begin_layout Standard
\begin_inset Float figure
placement h
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename simulink6time_handling.png
	scale 55

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Achievement of initial position area.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsection
MATLAB interpreted function set_starting_time
\end_layout

\begin_layout Subsubsection
Definition
\end_layout

\begin_layout Standard

\family typewriter
function starting_time = set_starting_time(in)
\end_layout

\begin_layout Subsubsection
Output parameters
\end_layout

\begin_layout Enumerate

\family typewriter
starting_time
\family default
 = 
\family typewriter
tmin
\family default
 in 
\family typewriter
OFFLINE
\family default
 modes.
 In 
\family typewriter
ONLINE
\family default
 mode, 
\family typewriter
starting_time
\family default
 = -1 if the initial condition have yet to be reached; otherwise, 
\family typewriter
starting_time
\family default
 = the instant in which they have been reached.
 In 
\family typewriter
ONLINE
\family default
 mode, the value of 
\family typewriter
starting_time
\family default
 is used in the other parts of the model to determine if the initial condition
 have been reached.
\end_layout

\begin_layout Subsubsection
Other outputs
\end_layout

\begin_layout Subsubsection
Throwable custom exceptions
\end_layout

\begin_layout Subsection
Interpreted MATLAB function store_real_time
\end_layout

\begin_layout Subsubsection
Definition
\end_layout

\begin_layout Standard

\family typewriter
function t = store_real_time (in)
\end_layout

\begin_layout Subsubsection
Output parameters
\end_layout

\begin_layout Enumerate

\family typewriter
t
\family default
 = 0 in mode 1 (this output is not significant).
 In mode 2, 
\family typewriter
t = toc
\family default
.
 In mode 3, 
\family typewriter
t = toc
\family default
 if 
\family typewriter
tic
\family default
 has been called (i.e.
 
\family typewriter
starting_time
\family default
 
\begin_inset Formula $\ge$
\end_inset

 0, see 14.1), otherwise 
\family typewriter
t =
\family default
 0.
\end_layout

\begin_layout Subsubsection
Other outputs
\end_layout

\begin_layout Subsubsection
Throwable custom exceptions
\end_layout

\begin_layout Subsubsection
Notes
\end_layout

\begin_layout Itemize
In the 
\family typewriter
OFFLINE
\family default
 modes, 
\family typewriter
set_starting_times
\family default
 runs 
\family typewriter
tic
\family default
 at the first simulation step, so 
\family typewriter
store_toc
\family default
 (which executes after 
\family typewriter
set_starting_times
\family default
 as it needs its output as input) can execute the 
\family typewriter
toc
\family default
 command always.
 In 
\family typewriter
ONLINE
\family default
 mode, 
\family typewriter
tic
\family default
 is only run by 
\family typewriter
set_starting_times
\family default
 at the step where initial conditions have been reached, so 
\family typewriter
toc
\family default
 can't be executed until then, and 0 will be returned instead.
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Section
Plot area
\end_layout

\begin_layout Standard
\align center
\begin_inset Float figure
placement H
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename simulink7plot.png
	scale 60

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Plot area.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsection
MATLAB interpreted function plot_robot_position
\end_layout

\begin_layout Subsubsection
Definition
\end_layout

\begin_layout Standard

\family typewriter
function plot_robot_position(in)
\end_layout

\begin_layout Subsubsection
Output parameters
\end_layout

\begin_layout Subsubsection
Other outputs
\end_layout

\begin_layout Itemize
If 
\family typewriter
plot_mode = 1
\family default
 (and, in 
\family typewriter
ONLINE
\family default
 mode, if 
\family typewriter
starting_time
\family default
 
\begin_inset Formula $\ge$
\end_inset

 0), the function plots, in blue, a straight line that goes from the previous
 position of the actuator to the current one, if the two positions are different
; it draws a point if they are equal, and at the first step (when a 
\begin_inset Quotes eld
\end_inset

previous position
\begin_inset Quotes erd
\end_inset

 doesn't exist).
\end_layout

\begin_layout Itemize
If 
\family typewriter
plot_mode = 2
\family default
 (and, in 
\family typewriter
ONLINE
\family default
 mode, if 
\family typewriter
starting_time
\family default
 
\begin_inset Formula $\ge$
\end_inset

 0), the function plots, at every step, two lines in the position of the
 robot's links, in blue.
 It also deletes the links drawn at the previous step, if any.
\end_layout

\begin_layout Itemize
Otherwise, it does nothing.
\end_layout

\begin_layout Itemize
If the figure is closed by the user while the simulation is running and
 
\family typewriter
plot_mode
\family default
 is not 0, the function re-opens the figure and issues a warning, with message
 
\family typewriter
It is recommended not to close the figure during the simulation.
\end_layout

\begin_layout Subsubsection
Throwable custom exceptions
\end_layout

\begin_layout Subsubsection
Notes
\end_layout

\begin_layout Paragraph
Note 1
\end_layout

\begin_layout Standard
This function, when plotting is enabled, is the bottleneck of the whole
 simulator, and dominates the execution time.
 For example, with 
\begin_inset Formula $t_{min}=0$
\end_inset

, 
\begin_inset Formula $t_{max}=6$
\end_inset

 s, 
\begin_inset Formula $h_{step}=0.001$
\end_inset

, 
\begin_inset Formula $\mathbf{x}^{*}(t)=(0.7\mathrm{cos}(10t),0.7\mathrm{sin}(10t)+0.01)$
\end_inset

, 
\begin_inset Formula $v_{max}=100$
\end_inset

, 
\begin_inset Formula $l_{1}=1$
\end_inset

, 
\begin_inset Formula $l_{2}=0.8$
\end_inset

, the simulation takes:
\end_layout

\begin_layout Itemize
10.931683 seconds with 
\family typewriter
plot_mode = PLOT_WITH_LINKS
\family default
.
\end_layout

\begin_layout Itemize
10.247887 seconds with 
\family typewriter
plot_mode = PLOT_NO_LINKS
\family default
.
\end_layout

\begin_layout Itemize
1.670445 seconds with 
\family typewriter
plot_mode = NO_PLOT
\family default
.
\end_layout

\begin_layout Standard
Although qualitatively, these results show the fact that the plotting heavily
 affects the running time.
 To avoid even more overhead, in the case of 
\family typewriter
plot_mode = PLOT_WITH_LINKS
\family default
 the two links are plotted through a single instruction.
\end_layout

\begin_layout Paragraph
Note 2
\end_layout

\begin_layout Standard
This function uses a local persistent variable, 
\family typewriter
plotted
\family default
, to store the latest element plotted in the figure in 
\family typewriter
PLOT_WITH_LINKS
\family default
 plot mode.
 At each call, if the variable is not empty, i.e.
 after the first links configuration is plotted, the command 
\family typewriter
delete(plotted)
\family default
 is issued, in order to erase the previous links configuration plot.
\end_layout

\begin_layout Standard
In 
\family typewriter
start_simulation
\family default
, after each simulation, the functions that use persistent variables are
 cleared (i.e.
 their persistent variables are reset to empty values), except for this
 one.
 This is because, after the end of a simulation, if there is a next one
 plotted will contain the latest links configuration of the previous simulation,
 and will be automatically erased.
\end_layout

\begin_layout Standard
Note that the command 
\family typewriter
clear plot_robot_position
\family default
 must be issued before 
\family typewriter
start_simulation
\family default
 returns (and, to cover the case of error exit, in 
\family typewriter
exit_with_error
\family default
, too).
\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Part
Examples of use
\end_layout

\begin_layout Section
Example 1
\end_layout

\begin_layout Standard
\noindent

\family typewriter
tmin=-0.1; tmax=1; h_step=0.001; t=tmin:h_step:tmax;
\end_layout

\begin_layout Standard
\noindent

\family typewriter
sim_struct = prepare_simulation('OFFLINE_GIVEN', 'PLOT_NO_LINKS', 1, 1,
 0.8, h_step, tmin, tmax, 0.6*cos(t), 0.6*sin(t));
\end_layout

\begin_layout Standard
Output:
\end_layout

\begin_layout Standard
\begin_inset Graphics
	filename run1fig1.png
	scale 50

\end_inset


\end_layout

\begin_layout Standard
\noindent
\align left

\family typewriter
[t, q1, q2, x, y, deltax, deltay] = start_simulation(sim_struct);
\end_layout

\begin_layout Standard
Output:
\end_layout

\begin_layout Standard
\begin_inset Graphics
	filename run1fig2.png
	scale 50

\end_inset


\end_layout

\begin_layout Standard
\noindent

\family typewriter
figure(2); plot(x{1}, y{1});
\end_layout

\begin_layout Standard
Output:
\end_layout

\begin_layout Standard
\begin_inset Graphics
	filename run1fig3.png
	scale 70

\end_inset


\end_layout

\begin_layout Section
Example 2
\end_layout

\begin_layout Standard
\noindent

\family typewriter
sim_struct = prepare_simulation('OFFLINE_MANUAL', 'PLOT_WITH_LINKS', 1,
 1, 0.8, 0.001);
\end_layout

\begin_layout Standard
Output:
\end_layout

\begin_layout Standard
\begin_inset Graphics
	filename run2fig1.png
	scale 50

\end_inset


\end_layout

\begin_layout Standard
After drawing one signals:
\end_layout

\begin_layout Standard
\begin_inset Graphics
	filename run2fig2.png
	scale 50

\end_inset


\end_layout

\begin_layout Standard
After choosing 
\begin_inset Quotes eld
\end_inset

Yes
\begin_inset Quotes erd
\end_inset

, drawing another signal and choosing 
\begin_inset Quotes eld
\end_inset

No
\begin_inset Quotes erd
\end_inset

:
\end_layout

\begin_layout Standard
\begin_inset Graphics
	filename run2fig3.png
	scale 50

\end_inset


\end_layout

\begin_layout Standard
\noindent
\align left

\family typewriter
[t, q1, q2, x, y, deltax, deltay] = start_simulation(sim_struct);
\end_layout

\begin_layout Standard
While plotting:
\end_layout

\begin_layout Standard
\begin_inset Graphics
	filename run2fig4.png
	scale 59

\end_inset


\end_layout

\begin_layout Standard
\noindent

\family typewriter
figure(2); hold on; grid on; axis([-2 2 -2 2]); plot(x{1}, y{1}, x{2}, y{2});
\end_layout

\begin_layout Standard
Output:
\end_layout

\begin_layout Standard
\begin_inset Graphics
	filename run2fig5.png
	scale 70

\end_inset


\end_layout

\begin_layout Section
Example 3
\end_layout

\begin_layout Standard

\family typewriter
sim_struct = prepare_simulation('ONLINE', 'PLOT_NO_LINKS', 1, 1, 0.8, 0.00001);
\end_layout

\begin_layout Standard
\noindent

\family typewriter
[t, q1, q2, x, y, deltax, deltay] = start_simulation(sim_struct);
\end_layout

\begin_layout Standard
Output after plotting some curves:
\end_layout

\begin_layout Standard
\begin_inset Graphics
	filename run3fig1.png
	scale 50

\end_inset


\end_layout

\begin_layout Standard
\noindent

\family typewriter
figure(2); hold on; for ii = 1 : max(size(x)) plot(x{ii}, y{ii},'.-'); end
\end_layout

\begin_layout Standard
Output:
\end_layout

\begin_layout Standard
\begin_inset Graphics
	filename run3fig2.png
	scale 70

\end_inset


\end_layout

\end_body
\end_document
